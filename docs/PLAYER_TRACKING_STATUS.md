# Player Tracking Feature - Status Report

**Fecha:** 2025-10-24
**Proyecto:** GOL360 - Panel de Destacados
**Feature:** Player Tracking Visualization

---

## üìã Resumen Ejecutivo

Se ha implementado un sistema completo de visualizaci√≥n de tracking de jugadores sobre videos de YouTube en el Panel de Destacados. El sistema descarga datos de posicionamiento de jugadores desde Firebase Storage y los visualiza en tiempo real sincronizados con el video.

---

## ‚úÖ Componentes Completados

### 1. Backend - Cloud Functions (`functions/src/tracking/`)

**Archivo:** `functions/src/tracking/index.ts`

**Estado:** ‚úÖ **COMPLETADO Y FUNCIONAL**

**Funcionalidad:**
- Proxy HTTP para servir archivos `player-tracking.json` desde Firebase Storage
- Resuelve problemas de CORS en desarrollo local
- Endpoint: `GET /tracking/:tournamentId/:matchId`
- Verifica existencia del archivo antes de servir
- Manejo de errores robusto
- Headers CORS configurados correctamente

**Path de datos en Storage:**
```
raw/{tournamentId}/{matchId}/player-tracking.json
```

**Integraci√≥n:**
- ‚úÖ Rutas registradas en `functions/src/index.ts` (l√≠nea 8, 22)
- ‚úÖ Express app configurado con CORS

---

### 2. Frontend Service (`src/services/playerTrackingService.ts`)

**Estado:** ‚úÖ **COMPLETADO Y FUNCIONAL**

**Caracter√≠sticas implementadas:**

#### Interfaces TypeScript
```typescript
- TrackingMetadata: Metadata almacenada en Firestore
- PlayerPosition: Posici√≥n de jugador (x, y, jersey, team)
- TrackingFrame: Frame con todos los jugadores
- PlayerTrackingData: Datos completos indexados por frame number
```

#### M√©todos principales

1. **`getTrackingMetadata(tournamentId, matchId)`**
   - Obtiene metadata desde Firestore
   - Path: `tournaments/{tournamentId}/matches/{matchId}/tracking/metadata`
   - Retorna: `TrackingMetadata | null`

2. **`downloadTrackingDataFromPath(tournamentId, matchId)`** ‚úÖ RECOMENDADO
   - Descarga usando Firebase Storage SDK
   - Maneja CORS autom√°ticamente
   - Obtiene download URL del Storage
   - ~5MB de datos JSON

3. **`downloadTrackingDataViaProxy(tournamentId, matchId)`** ‚úÖ ACTUALMENTE EN USO
   - Descarga a trav√©s de Cloud Function proxy
   - Evita problemas de CORS en desarrollo
   - URLs:
     - Dev: `http://127.0.0.1:5001/gol360-app/us-central1/api/tracking/{tournamentId}/{matchId}`
     - Prod: `/api/tracking/{tournamentId}/{matchId}`

4. **`downloadTrackingData(signedUrl)`**
   - M√©todo alternativo usando signed URL
   - Puede tener problemas de CORS

5. **`getFrameData(trackingData, frameNumber)`**
   - B√∫squeda binaria optimizada de frames
   - Cache de keys ordenadas
   - Encuentra el frame m√°s cercano al n√∫mero solicitado
   - Performance: O(log n)

#### Optimizaciones
- ‚úÖ Cache de keys ordenadas para b√∫squeda r√°pida
- ‚úÖ B√∫squeda binaria para encontrar frames
- ‚úÖ Logging detallado para debugging

---

### 3. UI Component - DestacadosPanel (`src/components/tournaments/panels/DestacadosPanel.vue`)

**Estado:** ‚úÖ **COMPLETADO Y FUNCIONAL**

**Secciones del componente:**

#### A. Props recibidos
```typescript
- playerMomentsData: PlayerMomentsData[] - Datos de momentos por jugador
- youtubeVideoId: string - ID del video de YouTube
- matchStart: string - Tiempo de inicio del partido en el video (MM:SS)
- tournamentId: string - ID del torneo
- matchId: string - ID del partido
- loading: boolean - Estado de carga
```

#### B. State de Tracking
```typescript
- trackingData: PlayerTrackingData | null - Datos de tracking descargados (~5MB)
- isLoadingTracking: boolean - Estado de descarga
- showTracking: boolean - Toggle de visualizaci√≥n
- canvasWidth: number - Ancho del canvas (1280px por defecto)
- canvasHeight: number - Alto del canvas (720px por defecto)
- currentVideoTime: number - Tiempo actual del video en segundos
```

#### C. YouTube Player Integration
- ‚úÖ YouTube IFrame API inicializado
- ‚úÖ Player creado din√°micamente en `youtubePlayerDiv`
- ‚úÖ Eventos: `onReady`, `onStateChange`
- ‚úÖ M√©todos: `seekTo()`, `playVideo()`, `pauseVideo()`, `getCurrentTime()`
- ‚úÖ Tracking de tiempo del video cada 100ms cuando est√° reproduciendo

#### D. Canvas Overlay
**Template (l√≠neas 129-136):**
```vue
<canvas
  v-if="showTracking && trackingData"
  ref="trackingCanvas"
  class="tracking-canvas"
  :width="canvasWidth"
  :height="canvasHeight"
></canvas>
```

**CSS (l√≠neas 1170-1178):**
```scss
.tracking-canvas {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none; /* No bloquea clics en el video */
  z-index: 2; /* Sobre el video */
}
```

#### E. Funciones de Tracking

1. **`loadTrackingData()`** (l√≠neas 621-676)
   - ‚úÖ Descarga datos usando `downloadTrackingDataViaProxy()`
   - ‚úÖ Guarda en `trackingData.value`
   - ‚úÖ Activa `showTracking` autom√°ticamente
   - ‚úÖ Logging detallado de frames
   - ‚úÖ Manejo de errores con instrucciones

2. **`resizeCanvas()`** (l√≠neas 680-692)
   - ‚úÖ Ajusta canvas al tama√±o del video wrapper
   - ‚úÖ Listener en window resize
   - ‚úÖ Mantiene aspect ratio

3. **`drawTracking()`** (l√≠neas 697-823) ‚ö†Ô∏è **FUNCIONAL PERO NECESITA AJUSTES**
   - ‚úÖ Limpia canvas en cada frame
   - ‚úÖ DEBUG: Dibuja rect√°ngulo rojo de prueba
   - ‚úÖ Calcula frame actual basado en tiempo de video
   - ‚úÖ Obtiene datos del frame usando `getFrameData()`
   - ‚úÖ Convierte coordenadas de metros a p√≠xeles
   - ‚úÖ Dibuja c√≠rculos para cada jugador
   - ‚úÖ Colores por equipo (rojo/azul)
   - ‚úÖ Resalta jugador seleccionado (amarillo, c√≠rculo grande)
   - ‚úÖ Muestra n√∫mero de camiseta

4. **`isPlayerSelectedByName(playerName)`** (l√≠neas 828-855)
   - ‚úÖ Compara nombre del tracking con jugador seleccionado
   - ‚úÖ B√∫squeda por nombre (case insensitive)
   - ‚úÖ B√∫squeda por n√∫mero de camiseta
   - ‚úÖ Maneja diferentes formatos: "Arsenal_11", "Portero", "Camisetan.¬∫11"

5. **`updateVideoTime()`** (l√≠neas 859-873)
   - ‚úÖ Obtiene tiempo actual de YouTube Player
   - ‚úÖ Actualiza `currentVideoTime.value`
   - ‚úÖ Manejo de errores

6. **`startVideoTimeTracking()` / `stopVideoTimeTracking()`** (l√≠neas 983-1003)
   - ‚úÖ Interval de 100ms para sincronizaci√≥n fluida
   - ‚úÖ Actualiza tiempo y redibuja canvas
   - ‚úÖ Solo cuando video est√° reproduciendo

#### F. UI Controls
**L√≠neas 96-116:**
```vue
<!-- Bot√≥n para cargar tracking -->
<q-btn
  v-if="!trackingData"
  outline
  color="secondary"
  icon="download"
  label="Cargar Tracking"
  :loading="isLoadingTracking"
  @click="loadTrackingData"
/>

<!-- Toggle para mostrar/ocultar tracking -->
<q-toggle
  v-else
  v-model="showTracking"
  color="secondary"
  icon="visibility"
  label="Tracking"
/>
```

#### G. Lifecycle Hooks
- ‚úÖ `onMounted()`: Inicializa canvas, YouTube Player, window resize listener
- ‚úÖ `onBeforeUnmount()`: Limpia intervals, listeners, destruye YouTube Player

---

### 4. Page Integration (`src/pages/tournaments/TournamentStats.vue`)

**Estado:** ‚úÖ **COMPLETADO**

**Props pasados a DestacadosPanel (l√≠neas 103-110):**
```vue
<DestacadosPanel
  :player-moments-data="playerMomentsData"
  :youtube-video-id="youtubeVideoId"
  :match-start="matchStart"
  :tournament-id="selectedMatch?.tournamentId || ''"
  :match-id="selectedMatch?.matchId || ''"
  :loading="isLoadingAnalytics"
/>
```

**Datos cargados desde Firestore:**
- ‚úÖ `youtubeVideoId` - Desde `matchMetadata.VIDEO_ID` (l√≠nea 256-263)
- ‚úÖ `matchStart` - Desde `matchMetadata.MATCH_START` (l√≠nea 265-272)
- ‚úÖ `playerMomentsData` - Filtrado por rol de usuario (l√≠nea 176-179, 340-363)

---

## üéØ Estado Actual del Sistema

### Lo que FUNCIONA ‚úÖ

1. **Backend proxy**: Sirve archivos JSON sin problemas de CORS
2. **Descarga de datos**: ~5MB de tracking data se descarga correctamente
3. **Canvas overlay**: Se renderiza sobre el video de YouTube
4. **Sincronizaci√≥n**: Tiempo de video se actualiza cada 100ms
5. **Conversi√≥n de coordenadas**: Metros ‚Üí P√≠xeles funciona
6. **Dibujado de jugadores**: C√≠rculos aparecen en el canvas
7. **Colores por equipo**: Rojo (home) / Azul (away)
8. **Jugador seleccionado**: Se resalta en amarillo con c√≠rculo grande
9. **N√∫mero de camiseta**: Se muestra en cada c√≠rculo

### Problema Actual üö®

**S√≠ntoma:**
> "Aparecen unos puntos por todos lados rojos azules y un amarillo grande"

**Diagn√≥stico:**

El sistema est√° dibujando correctamente, pero las **posiciones NO coinciden** con las posiciones reales de los jugadores en el video.

**Posibles causas:**

1. **Formato de datos incorrecto**
   - L√≠nea 764: `const [playerName, jersey, xMeters, yMeters] = playerData`
   - Asume estructura: `[nombre, jersey, x, y]`
   - ‚ö†Ô∏è **NECESITA VERIFICACI√ìN**: ¬øEs esta la estructura real del JSON?

2. **Sistema de coordenadas incorrecto**
   - L√≠neas 755-757: Asume campo de 105m x 68m
   - Asume (0,0) en el centro del campo
   - Asume rango: x: [-52.5, 52.5], y: [-34, 34]
   - ‚ö†Ô∏è **NECESITA VERIFICACI√ìN**: ¬øEs este el sistema de coordenadas correcto?

3. **Aspecto ratio del canvas vs video**
   - Canvas: 16:9 (l√≠nea 1151)
   - Video: 16:9 (YouTube est√°ndar)
   - ‚ö†Ô∏è Puede haber desajuste si el video tiene letterboxing

4. **Offset del frame incorrecto**
   - L√≠nea 732: `const currentFrame = Math.floor(currentVideoTime.value - matchStartSeconds)`
   - ‚ö†Ô∏è **NECESITA VERIFICACI√ìN**: ¬øLos frames del tracking empiezan en 0 desde el inicio del partido?

---

## üîß Tareas Pendientes

### CR√çTICO üî¥ - Necesario para funcionalidad b√°sica

1. **[ ] Verificar estructura real del JSON de tracking**
   - Inspeccionar archivo: `raw/{tournamentId}/{matchId}/player-tracking.json`
   - Documentar estructura exacta
   - Ejemplo esperado:
     ```json
     {
       "0": {
         "player_1": [...],
         "player_2": [...]
       }
     }
     ```
   - Ajustar parsing en `drawTracking()` si es necesario

2. **[ ] Verificar sistema de coordenadas**
   - ¬øLas coordenadas est√°n en metros o normalizadas (0-1)?
   - ¬øCu√°l es el origen (0,0)?
   - ¬øCu√°l es el rango de valores?
   - ¬øQu√© representa cada eje (X=largo, Y=ancho)?

3. **[ ] Calibrar conversi√≥n de coordenadas**
   - Probar con un jugador conocido en un momento espec√≠fico
   - Comparar posici√≥n visual en video vs posici√≥n dibujada
   - Ajustar f√≥rmula de conversi√≥n (l√≠neas 769-773)

4. **[ ] Verificar sincronizaci√≥n frame-video**
   - Confirmar que `trackingStart` en `PlayerMoment` corresponde a segundos desde inicio del partido
   - Confirmar que `matchStart` representa el offset correcto
   - Log valores para debugging:
     ```typescript
     console.log({
       videoTime: currentVideoTime.value,
       matchStart: matchStartSeconds,
       calculatedFrame: currentFrame,
       frameExists: frameData ? 'YES' : 'NO'
     })
     ```

### IMPORTANTE üü° - Mejoras de UX

5. **[ ] Remover rect√°ngulo rojo de debug**
   - L√≠neas 724-728 en `drawTracking()`
   - Est√° ah√≠ solo para verificar que el canvas funciona

6. **[ ] Detectar equipo autom√°ticamente**
   - L√≠nea 781: `const isHome = playerName.includes('Arsenal')`
   - ‚ö†Ô∏è Hardcodeado para un equipo espec√≠fico
   - Necesita detectar din√°micamente basado en datos del partido

7. **[ ] Mejorar matching de jugador seleccionado**
   - Funci√≥n `isPlayerSelectedByName()` puede fallar con nombres complejos
   - Considerar usar ID √∫nico si est√° disponible en los datos

8. **[ ] Agregar feedback visual cuando no hay datos**
   - Mostrar mensaje si tracking no est√° disponible para el frame actual
   - Indicar rango de frames disponibles

### OPCIONAL üü¢ - Mejoras visuales

9. **[ ] Trails de movimiento**
   - Dibujar las √∫ltimas N posiciones del jugador
   - Efecto de "estela" para visualizar trayectoria

10. **[ ] Heatmap**
    - Acumular posiciones durante el partido
    - Visualizar zonas m√°s frecuentadas

11. **[ ] Team colors personalizados**
    - Cargar colores reales de los equipos desde Firestore
    - Aplicar en lugar de rojo/azul gen√©ricos

12. **[ ] Nombres de jugadores en hover**
    - Detectar hover sobre c√≠rculos (requiere pointer-events)
    - Mostrar tooltip con info del jugador

13. **[ ] Mini-mapa de campo**
    - Dibujar l√≠neas del campo de f√∫tbol en el canvas
    - Ayuda a orientaci√≥n espacial

14. **[ ] Performance optimization**
    - Considerar renderizar solo jugadores visibles en pantalla
    - Throttle de `drawTracking()` si hay lag

---

## üìù Notas T√©cnicas

### Estructura de Datos Esperada

**Firestore - Match Metadata:**
```
tournaments/{tournamentId}/matches/{matchId}/metadata
{
  VIDEO_ID: "DtD7GNuF3xQ",
  MATCH_START: "08:25", // MM:SS - Cuando empieza el partido en el video
  VAR_TIME: 0 // Segundos a ajustar
}
```

**Firestore - Player Moments:**
```
tournaments/{tournamentId}/matches/{matchId}/playerMoments/{side}_{namePlayer}
{
  side: "home" | "away",
  team: "Arsenal FC",
  namePlayer: "Portero",
  momentsCount: 5,
  moments: [
    {
      startTime: "00:54", // MM:SS desde inicio del partido
      duration: "14s",
      trackingStart: 54, // Frame (segundo) inicial
      trackingEnd: 68 // Frame (segundo) final
    }
  ]
}
```

**Storage - Player Tracking JSON:**
```
raw/{tournamentId}/{matchId}/player-tracking.json
{
  "0": { // Frame number (segundo del partido)
    "player_id_1": [playerName, jersey, x, y, ?],
    "player_id_2": [playerName, jersey, x, y, ?],
    ...
  },
  "1": { ... },
  ...
}
```

### Conversi√≥n de Coordenadas

**F√≥rmula actual (l√≠neas 755-773):**
```typescript
const FIELD_WIDTH = 105  // metros
const FIELD_HEIGHT = 68  // metros

// Asume centro del campo en (0,0)
const xNormalized = (xMeters + FIELD_WIDTH / 2) / FIELD_WIDTH  // 0 a 1
const yNormalized = (yMeters + FIELD_HEIGHT / 2) / FIELD_HEIGHT  // 0 a 1

const x = xNormalized * canvas.width
const y = yNormalized * canvas.height
```

**‚ö†Ô∏è IMPORTANTE:** Esta f√≥rmula asume:
- Coordenadas en metros
- Origen en centro del campo
- Rango X: [-52.5, 52.5]
- Rango Y: [-34, 34]

**Si esto no es correcto, la f√≥rmula debe ajustarse.**

### Sincronizaci√≥n Video-Tracking

**Flujo de tiempo:**
```
1. Usuario hace clic en momento ‚Üí startTime: "00:54" (MM:SS)
2. Se convierte a segundos ‚Üí 54s (desde inicio del partido)
3. Se suma MATCH_START ‚Üí videoTime = 54s + matchStartSeconds
4. YouTube Player salta a ‚Üí videoTime
5. Canvas calcula frame ‚Üí currentFrame = videoTime - matchStartSeconds
6. Se busca tracking data ‚Üí trackingData[currentFrame]
```

---

## üß™ Plan de Testing

### Test 1: Verificar estructura de datos
```typescript
// En loadTrackingData(), despu√©s de descargar
const firstFrame = Object.keys(data)[0]
const firstPlayer = Object.keys(data[firstFrame])[0]
console.log('First frame:', firstFrame)
console.log('First player data:', data[firstFrame][firstPlayer])
console.log('Data structure:', {
  type: typeof data[firstFrame][firstPlayer],
  isArray: Array.isArray(data[firstFrame][firstPlayer]),
  length: data[firstFrame][firstPlayer]?.length,
  values: data[firstFrame][firstPlayer]
})
```

### Test 2: Verificar rango de coordenadas
```typescript
// En loadTrackingData()
const allCoords = []
Object.values(data).forEach(frame => {
  Object.values(frame).forEach(player => {
    if (Array.isArray(player) && player.length >= 4) {
      allCoords.push({ x: player[2], y: player[3] })
    }
  })
})

const xValues = allCoords.map(c => c.x)
const yValues = allCoords.map(c => c.y)

console.log('Coordinate ranges:', {
  x: { min: Math.min(...xValues), max: Math.max(...xValues) },
  y: { min: Math.min(...yValues), max: Math.max(...yValues) }
})
```

### Test 3: Verificar sincronizaci√≥n
```typescript
// En drawTracking(), agregar despu√©s de l√≠nea 734
console.log('Sync check:', {
  videoTime: currentVideoTime.value.toFixed(1),
  matchStart: matchStartSeconds,
  calculatedFrame: currentFrame,
  frameExists: !!frameData,
  playersInFrame: frameData ? Object.keys(frameData).length : 0
})
```

---

## üìÇ Archivos del Feature

```
Gol-360-App/
‚îú‚îÄ‚îÄ functions/src/
‚îÇ   ‚îú‚îÄ‚îÄ tracking/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts                    ‚úÖ Cloud Function proxy
‚îÇ   ‚îî‚îÄ‚îÄ index.ts                        ‚úÖ Registro de rutas
‚îÇ
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ playerTrackingService.ts    ‚úÖ Service layer
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ components/tournaments/panels/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ DestacadosPanel.vue         ‚úÖ UI Component
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ pages/tournaments/
‚îÇ       ‚îî‚îÄ‚îÄ TournamentStats.vue         ‚úÖ Page integration
‚îÇ
‚îî‚îÄ‚îÄ docs/
    ‚îî‚îÄ‚îÄ PLAYER_TRACKING_STATUS.md       üìÑ Este documento
```

---

## üöÄ Siguiente Sesi√≥n - Plan de Acci√≥n

**Objetivo:** Corregir posicionamiento de jugadores en el canvas

**Pasos:**

1. **Inspeccionar archivo de tracking real**
   - Descargar manualmente desde Storage Console
   - O agregar logging completo en `loadTrackingData()`
   - Documentar estructura exacta

2. **Ajustar parsing de datos**
   - Modificar `drawTracking()` seg√∫n estructura real
   - Probar con diferentes formatos

3. **Calibrar coordenadas**
   - Agregar tests de rango (ver secci√≥n Testing)
   - Ajustar constantes `FIELD_WIDTH` y `FIELD_HEIGHT`
   - Ajustar f√≥rmula de conversi√≥n si es necesario

4. **Verificar sincronizaci√≥n**
   - Agregar logging detallado
   - Confirmar que frames corresponden a segundos correctos

5. **Testing visual**
   - Cargar tracking data
   - Comparar posiciones en video vs canvas
   - Iterar ajustes hasta que coincidan

---

## üìû Preguntas para el Cliente/Equipo

1. ¬øCu√°l es la estructura exacta del JSON de tracking?
2. ¬øEn qu√© unidades est√°n las coordenadas (metros, p√≠xeles, normalizadas)?
3. ¬øCu√°l es el sistema de coordenadas (origen, ejes, rangos)?
4. ¬øLos frames del tracking est√°n sincronizados con el inicio del partido o del video?
5. ¬øHay alguna documentaci√≥n de Veo.co sobre su formato de tracking data?

---

**√öltima actualizaci√≥n:** 2025-10-24
**Autor:** Claude Code AI Assistant
**Status general:** üü° Funcional pero requiere calibraci√≥n de coordenadas
